<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eosa.admin.mapper.RequestMapper">

    <!-- 의뢰 목록 개수 조회 -->
    <select id="countRequestList" resultType="int" parameterType="hashmap">
        SELECT COUNT(*)
        FROM RequestForm R
                 JOIN Users U on R.usersIdx = U.usersIdx
                 JOIN Companys C on R.companysIdx = C.companysIdx
        <where>
            <if test="state != null">
                AND R.requestFormStatus = #{state}
            </if>
            <if test="sort == 'client'">
                AND CONCAT(U.usersAccount) REGEXP #{search}
            </if>
            <if test="sort == 'company'">
                AND CONCAT(C.companysName) REGEXP #{search}
            </if>
        </where>
    </select>

    <!-- 의뢰 목록 조회 -->
    <select id="selectRequestList" resultType="RequestDTO" parameterType="hashmap">
        SELECT R.requestFormIdx,
               R.usersIdx,
               R.companysIdx,
               R.requestFormRegion1,
               R.requestFormChannel,
               R.requestFormStatus,
               R.requestFormDate,
               RC.requestFormCategoryValue,
               U.usersAccount,
               C.companysName
        FROM RequestForm R
                 JOIN (SELECT RFC.requestFormIdx,
                              GROUP_CONCAT(RFC.requestFormCategoryValue SEPARATOR '|') requestFormCategoryValue
                       FROM RequestFormCategory RFC
                       GROUP BY RFC.requestFormIdx) RC ON R.requestFormIdx = RC.requestFormIdx
                 JOIN Users U on R.usersIdx = U.usersIdx
                 JOIN Companys C on R.companysIdx = C.companysIdx
        <where>
            <if test="state != null">
                AND R.requestFormStatus = #{state}
            </if>
            <if test="sort == 'client'">
                AND CONCAT(U.usersAccount) REGEXP #{search}
            </if>
            <if test="sort == 'company'">
                AND CONCAT(C.companysName) REGEXP #{search}
            </if>
        </where>
        ORDER BY R.requestFormDate DESC LIMIT #{startIndex}, #{pageSize}
    </select>

    <!-- 의뢰 삭제 -->
    <delete id="deleteRequest" parameterType="long">
        DELETE
        FROM RequestForm
        WHERE requestFormIdx = #{requestFormIdx}
    </delete>

    <!-- 의뢰 분야 삭제 -->
    <delete id="deleteRequestCategory" parameterType="long">
        DELETE
        FROM RequestFormCategory
        WHERE requestFormIdx = #{requestFormIdx}
    </delete>

    <!-- 의뢰 수정 -->
    <update id="updateRequest" parameterType="RequestDTO">
        UPDATE RequestForm
        SET requestFormRegion1 = #{requestFormRegion1},
            requestFormStatus  = #{requestFormStatus}
        WHERE requestFormIdx = #{requestFormIdx}
    </update>

    <!-- 의뢰 분야 등록 -->
    <insert id="insertRequestCategory" parameterType="RequestDTO">
        INSERT INTO RequestFormCategory (requestFormIdx,
                                         requestFormCategoryValue)
        VALUES (#{requestFormIdx},
                #{requestFormCategoryValue})
    </insert>

    <!-- companysIdx가 일치하는 RequestDTO 조회 -->
    <select id="requestDTOByCompanysIdx"  resultType="RequestDTO" parameterType="Long">
        SELECT 
        r.requestFormIdx,
        r.usersIdx,
        r.companysIdx,
        r.requestFormRegion1,
        r.requestFormChannel,
        r.requestFormStatus,
        r.requestConsultDate,
        r.requestFormAcceptDate,
        r.requestFormCompDate,
        r.requestFormRejectMessage,
        rc.requestFormCategoryValue,
        u.usersAccount,
        c.companysName
        FROM RequestForm r
        JOIN (SELECT RFC.requestFormIdx,
                    GROUP_CONCAT(RFC.requestFormCategoryValue SEPARATOR '|') requestFormCategoryValue
                FROM RequestFormCategory RFC GROUP BY RFC.requestFormIdx) rc ON r.requestFormIdx = rc.requestFormIdx
        JOIN Users u ON r.usersIdx = u.usersIdx
        JOIN Companys c ON r.companysIdx = c.companysIdx
        WHERE r.companysIdx = #{companysIdx}
    </select>

</mapper>
