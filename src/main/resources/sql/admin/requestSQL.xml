<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eosa.admin.mapper.RequestMapper">

    <!-- 의뢰 목록 개수 조회 -->
    <select id="countRequestList" resultType="int" parameterType="hashmap">
        SELECT COUNT(*)
        FROM RequestForm R
                 JOIN Users U on R.usersIdx = U.usersIdx
                 JOIN Companys C on R.companysIdx = C.companysIdx
        <where>
            <if test="state != null">
                AND R.requestFormStatus = #{state}
            </if>
            <if test="sort == 'client'">
                AND CONCAT(U.usersAccount) REGEXP #{search}
            </if>
            <if test="sort == 'company'">
                AND CONCAT(C.companysName) REGEXP #{search}
            </if>
        </where>
    </select>

    <!-- 의뢰 목록 조회 -->
    <select id="selectRequestList" resultType="RequestDTO" parameterType="hashmap">
        SELECT R.requestFormIdx,
               R.usersIdx,
               R.companysIdx,
               R.requestFormRegion1,
               R.requestFormChannel,
               R.requestFormStatus,
               R.requestFormDate,
               RC.requestFormCategoryValue,
               U.usersAccount,
               C.companysName
        FROM RequestForm R
                 JOIN (SELECT RFC.requestFormIdx,
                              GROUP_CONCAT(RFC.requestFormCategoryValue SEPARATOR '|') requestFormCategoryValue
                       FROM RequestFormCategory RFC
                       GROUP BY RFC.requestFormIdx) RC ON R.requestFormIdx = RC.requestFormIdx
                 JOIN Users U on R.usersIdx = U.usersIdx
                 JOIN Companys C on R.companysIdx = C.companysIdx
        <where>
            <if test="state != null">
                AND R.requestFormStatus = #{state}
            </if>
            <if test="sort == 'client'">
                AND CONCAT(U.usersAccount) REGEXP #{search}
            </if>
            <if test="sort == 'company'">
                AND CONCAT(C.companysName) REGEXP #{search}
            </if>
        </where>
        ORDER BY R.requestFormDate DESC LIMIT #{startIndex}, #{pageSize}
    </select>

</mapper>
