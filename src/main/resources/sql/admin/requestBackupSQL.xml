<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eosa.admin.mapper.RequestBackupMapper">

    <!-- 의뢰 목록 개수 조회 -->
    <select id="countRequestList" resultType="int" parameterType="hashmap">
        SELECT COUNT(*)
        FROM RequestFormBackup R
                 JOIN Users U on R.usersIdx = U.usersIdx
                 JOIN Companys C on R.companysIdx = C.companysIdx
        <where>
            <if test="state != null">
                AND R.requestFormStatus = #{state}
            </if>
            <if test="sort == 'client'">
                AND CONCAT(U.usersAccount) REGEXP #{search}
            </if>
            <if test="sort == 'company'">
                AND CONCAT(C.companysName) REGEXP #{search}
            </if>
        </where>
    </select>

    <!-- 의뢰 목록 조회 -->
    <select id="selectRequestList" resultType="RequestBackupDTO" parameterType="hashmap">
        SELECT
            R.requestFormBackupIdx,
            R.requestFormIdx,
            R.usersIdx,
            R.companysIdx,
            R.requestFormRegion1,
            R.requestFormChannel,
            R.requestFormStatus,
            R.requestFormDate,
            RC.requestFormCategoryValue,
            U.usersAccount,
            C.companysName
        FROM RequestFormBackup R
                 JOIN (SELECT RFC.requestFormBackupIdx,
                              GROUP_CONCAT(RFC.requestFormCategoryValue SEPARATOR '|') requestFormCategoryValue
                       FROM RequestFormCategoryBackup RFC
                       GROUP BY RFC.requestFormBackupIdx) RC ON R.requestFormBackupIdx = RC.requestFormBackupIdx
                 JOIN Users U on R.usersIdx = U.usersIdx
                 JOIN Companys C on R.companysIdx = C.companysIdx
        <where>
            <if test="state != null">
                AND R.requestFormStatus = #{state}
            </if>
            <if test="sort == 'client'">
                AND CONCAT(U.usersAccount) REGEXP #{search}
            </if>
            <if test="sort == 'company'">
                AND CONCAT(C.companysName) REGEXP #{search}
            </if>
        </where>
        ORDER BY R.requestFormDate DESC LIMIT #{startIndex}, #{pageSize}
    </select>

    <!-- 의뢰 삭제 -->
    <delete id="deleteRequest" parameterType="long">
        DELETE
        FROM RequestFormBackup
        WHERE requestFormIdx = #{requestFormIdx}
    </delete>

    <!-- 의뢰 분야 삭제 -->
    <delete id="deleteRequestCategory" parameterType="long">
        DELETE
        FROM RequestFormCategoryBackup
        WHERE requestFormBackupIdx = #{requestFormBackupIdx}
    </delete>

    <!-- 의뢰 수정 -->
    <update id="updateRequest" parameterType="RequestBackupDTO">
        UPDATE RequestFormBackup
        SET requestFormRegion1 = #{requestFormRegion1},
            requestFormStatus  = #{requestFormStatus}
        WHERE requestFormBackupIdx = #{requestFormBackupIdx}
    </update>

    <!-- 의뢰 분야 등록 -->
    <insert id="insertRequestCategory" parameterType="RequestBackupDTO">
        INSERT INTO RequestFormCategory (requestFormIdx,
                                         requestFormCategoryValue)
        VALUES (#{requestFormIdx},
                #{requestFormCategoryValue})
    </insert>

    <!-- companysIdx가 일치하는 RequestDTO 조회 -->
    <select id="requestDTOByCompanysIdx"  resultType="RequestBackupDTO" parameterType="Long">
        SELECT
        r.requestFormBackupIdx,
        r.requestFormIdx,
        r.usersIdx,
        r.companysIdx,
        r.requestFormRegion1,
        r.requestFormChannel,
        r.requestFormStatus,
        r.requestConsultDate,
        r.requestFormAcceptDate,
        r.requestFormCompDate,
        r.requestFormRejectMessage,
        rc.requestFormCategoryValue,
        u.usersAccount,
        c.companysName
        FROM RequestFormBackup r
        JOIN (SELECT RFC.requestFormBackupIdx,
                    GROUP_CONCAT(RFC.requestFormCategoryValue SEPARATOR '|') requestFormCategoryValue
                FROM RequestFormCategoryBackup RFC GROUP BY RFC.requestFormBackupIdx) rc ON r.requestFormBackupIdx = rc.requestFormBackupIdx
        JOIN Users u ON r.usersIdx = u.usersIdx
        JOIN Companys c ON r.companysIdx = c.companysIdx
        WHERE r.companysIdx = #{companysIdx}
    </select>

    <!-- 모든 RequestDTO 조회 -->
    <select id="selectAllRequestDTO"  resultType="RequestBackupDTO">
        SELECT 
        r.requestFormBackupIdx,
        r.requestFormIdx,
        r.usersIdx,
        r.companysIdx,
        r.requestFormRegion1,
        r.requestFormChannel,
        r.requestFormStatus,
        r.requestConsultDate,
        r.requestFormAcceptDate,
        r.requestFormCompDate,
        r.requestFormRejectMessage,
        rc.requestFormCategoryValue
        FROM RequestFormBackup r
        JOIN (SELECT RFC.requestFormBackupIdx,
                    GROUP_CONCAT(RFC.requestFormCategoryValue SEPARATOR '|') requestFormCategoryValue
                FROM RequestFormCategoryBackup RFC GROUP BY RFC.requestFormBackupIdx) rc ON r.requestFormBackupIdx = rc.requestFormBackupIdx
    </select>

    <!-- 모든 RequestDTO 조회2 -->
    <select id="selectAllRequestDTO2"  resultType="RequestBackupDTO">
        SELECT 
        r.requestFormBackupIdx,
        r.requestFormIdx,
        r.usersIdx,
        u.usersGender,
        u.usersAge,
        r.companysIdx,
        r.requestFormRegion1,
        r.requestFormChannel,
        r.requestFormStatus,
        r.requestConsultDate,
        r.requestFormAcceptDate,
        r.requestFormCompDate,
        r.requestFormRejectMessage,
        rc.requestFormCategoryValue
        FROM RequestFormBackup r
        JOIN (SELECT RFC.requestFormBackupIdx,
                    GROUP_CONCAT(RFC.requestFormCategoryValue SEPARATOR '|') requestFormCategoryValue
                FROM RequestFormCategoryBackup RFC GROUP BY RFC.requestFormBackupIdx) rc ON r.requestFormBackupIdx = rc.requestFormBackupIdx
        JOIN Users u ON r.usersIdx = u.usersIdx 
    </select>


    
</mapper>
