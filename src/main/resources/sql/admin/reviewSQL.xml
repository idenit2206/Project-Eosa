<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eosa.admin.mapper.ReviewMapper">

    <!-- 리뷰 목록 개수 조회 -->
    <select id="countReviewList" resultType="int" parameterType="hashmap">
        SELECT COUNT(*)
        FROM UsersReview R
                 JOIN Users U ON R.reviewUsersIdx = U.usersIdx
                 JOIN Companys C ON R.reviewCompanysIdx = C.companysIdx
        <where>
            <if test="company != null">
                AND CONCAT(C.companysName) REGEXP #{search}
            </if>
            <if test="writer != null">
                AND CONCAT(U.usersAccount) REGEXP #{search}
            </if>
        </where>
    </select>

    <!-- 리뷰 목록 조회 -->
    <select id="selectReviewList" resultType="ReviewDTO" parameterType="hashmap">
        SELECT R.idx,
               R.reviewCompanysIdx,
               R.resultScore,
               R.communicationScore,
               R.processScore,
               R.specialityScore,
               ROUND((R.resultScore + R.communicationScore + R.processScore + R.specialityScore) / 4, 2) average,
               R.reviewDetail,
               R.reviewDate,
               U.usersAccount,
               C.companysName
        FROM UsersReview R
                 JOIN Users U ON R.reviewUsersIdx = U.usersIdx
                 JOIN Companys C ON R.reviewCompanysIdx = C.companysIdx
        <where>
            <if test="company != null">
                AND CONCAT(C.companysName) REGEXP #{search}
            </if>
            <if test="writer != null">
                AND CONCAT(U.usersAccount) REGEXP #{search}
            </if>
        </where>
        ORDER BY R.reviewDate DESC LIMIT #{startIndex}, #{pageSize}
    </select>

    <!-- 리뷰 삭제 -->
    <delete id="deleteReview" parameterType="long">
        DELETE
        FROM UsersReview
        WHERE idx = ${idx}
    </delete>

    <!-- 리뷰 다중 삭제 -->
    <delete id="deleteReviewMulti">
        DELETE
        FROM UsersReview
        WHERE idx IN
        <foreach collection="array" item="arr" index="i" open="(" separator="," close=")">
            #{arr}
        </foreach>
    </delete>

</mapper>
