<!DOCTYPE html>
<html lang="ko" oncontextmenu="return false" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>계약서 사인</title>
	<style>
		.sign-form {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			display: flex;
			align-items: center;
			justify-content: center;
			flex-direction: column;
			gap: 50px;
		}
		.sign-form span {
			font-size: 18px;
			font-weight: 600;
			color: #212121;
			line-height: 140%;
		}
		.sign-form button {
			width: 139px;
			height: 46px;
			border: none;
			border-radius: 99px;
			background: #4C956C;
			font-family: 'Pretendard';
			font-size: 16px;
			color: #fff;
			line-height: 46px;
			letter-spacing: -1px;
			cursor: pointer;
			font-weight: 600;
		}
		.sigh-form .btn-wrap {
			display: flex;
			flex-direction: column;
			justify-content: center;
			gap: 20px;
		}
	</style>
</head>
<body>
	<div class="sign-form">
		<input type="hidden" th:value="${path}" class="path">
		<span>서명이 완료되었습니다.</span>
		<div class="btn-wrap">
			<button type="button" class="btn-return" onclick="location.href='https://dowajo.co.kr'">홈</button>
			<!-- <button type="button" class="btn-return">돌아가기</button> -->
		</div>
	</div>
</body>
<script>
	function NotReload(){
		if( (event.ctrlKey == true && (event.keyCode == 78 || event.keyCode == 82)) || (event.keyCode == 116) ) {
			event.keyCode = 0;
			event.cancelBubble = true;
			event.returnValue = false;
		}
	}

	window.addEventListener('load', function () {
		document.onkeydown = NotReload;
		document.querySelector('.btn-return').addEventListener('click', e => {
			location.href = document.querySelector('.path').value;
		});
	});

	const currentURL = window.location.href;
	const urlObject = new URL(currentURL).searchParams;
	const documentId = urlObject.get("documentId");
	const requestFormIdx = urlObject.get("requestFormIdx");
	
	const REJECT_SIGN = "REJECT_SIGNING";

	const url = `https://api.modusign.co.kr/documents/${documentId}/histories`;
	const options = {
	method: 'GET',
	headers: {
		accept: 'application/json',
		authorization: 'Bearer Basic IHByb2plY3Rlb3NhQG5hdmVyLmNvbTpZV0V4Tm1Jek5EZ3RPR1l3TUMwMFpXSXdMVGsxT0RVdE1tSTNPVFU0TjJNMFpqVm0='
	}
	};

	let checkDocument = () => {	
		return fetch(url, options)
			.then(res => res.json())
			.then(json => {
				let result = 0;
				// console.log(json.histories[0]);
				for(let i = 0; i < json.histories.length; i++) {
					if(json.histories[i].action == REJECT_SIGN) {					
						console.log(`${i} 에서 ${REJECT_SIGN}`);
						result = 1;
					}
				}
				return result;
			})
			.catch(err => console.error('error:' + err));
	}
	let checkDocumentResult = 0;
	checkDocument().then(result => {
		checkDocumentResult = result;
		if(checkDocumentResult == 1) {
			console.log("사용자의 계약서 서명 거절로 인한 계약 취소");
			let subFetchURL = `http://localhost:8081/api/requestForm/updateRequestFormStatusByRequestFormIdx`;
			let formData = new FormData();
			formData.set("requestFormIdx", requestFormIdx);
			formData.set("requestFormStatus", "계약취소");
			formData.set("requestFormRejectMessage", "계약 서명 거절로 인한 계약 취소");
			fetch(subFetchURL, {
				method: "POST",
				body: formData
			})
			.then(response => {
				response.json();
			})
			.then(data => {
				console.log(data);
			})
		}
		else {
			console.log("계약 완료 다음 수순으로");
		}
	})
	
	
</script>
</html>